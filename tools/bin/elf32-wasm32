#!/bin/bash
set -o pipefail
set -o errexit
TMPD=$(mktemp -d --tmpdir elf-wasm.XXXXXXXXXXX);
$(dirname "$0")/elf-to-wasm --executable --dynamic "$1" > $TMPD/wasm
EXECUTABLE="$1"
shift;
if [ x"$WASMGDB" != x ]; then
    GDBARGS="--gdbpipes $TMPD"
    mkfifo "$TMPD/out"
    $(dirname "$0")/wasm $GDBARGS "$TMPD/wasm" "$@" &
    echo $! > $TMPD/pid
    $WASMDIR/wasm32-unknown-none/bin/wasm32-unknown-none-gdb -ex 'file '"$EXECUTABLE" -ex ' target extended-remote | '"$WASMDIR"'/tools/bin/bitpush '"$TMPD"
else
    $(dirname "$0")/wasm "$TMPD/wasm" "$@"
fi
EXIT=$?
rm -rf $TMPD
exit $EXIT
